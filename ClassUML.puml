@startuml
'https://plantuml.com/class-diagram
title Class Diagram

package org.springframework {
    package boot {
        class SpringApplication {}
    }

    package web {
        package filter {
            class OncePerRequestFilter {}
        }


        package servlet {
            interface HandlerInterceptor {}

            package config {
                package annotation {
                    interface WebMvcConfigurer {}
                      interface WebMvcConfigurer {}
                }
            }
        }
    }

    package data {
        package jpa {
            package repository {
                class JpaRepository {}
            }
        }
    }
}

note right of org.springframework
  Spring Boot Framework
  Not part of application, but is called several times.
end note

package com.chachef {
    package entity {
        class User {
            - userId: UUID [1]
            - username: String [1]
            - name: String [1]
            - passwordHash: String [1]

            + getUserId(): UUID
            + getUsername(): String
            + setUsername(username: String): void
            + getName(): String
            + setName(name: String): void
            + getPasswordHash(): String
            + setPasswordHash(passwordHash: String): void
        }

        class Chef {
            - chefId: UUID [1]
            - user: User [1]
            - price: double [1]
            - listingName: String [1]

            + getChefId(): UUID
            + getUser(): User
            + setUser(user: User): void
            + getPrice(): double
            + setPrice(price: double): void
            + getListingName(): String
            + setListingName(listingName: String): void
        }

        class Booking {
            - bookingId: UUID [1]
            - user: User [1]
            - chef: Chef [1]
            - start: LocalDateTime [1]
            - end: LocalDateTime [1]
            - address: String [1]
            - status: String [1]

            + getBookingId(): UUID
            + getUser(): User
            + setUser(user: User): void
            + getChef(): Chef
            + setChef(Chef: Chef): void
            + getStart(): LocalDateTime
            + setStart(start: LocalDateTime): void
            + getEnd(): LocalDateTime
            + setEnd(end: LocalDateTime): void
            + getAddress(): String
            + setAddress(address: String): void
            + getStatus(): String
            + setStatus(status: String): void
        }

        class RefreshTokens {
            - refreshId: UUID [1]
            - user: User [1]
            - expires: LocalDateTime [1]

            + getRefreshId(): UUID
            + getExpires(): LocalDateTime
            + setExpires(expires: LocalDateTime): void
            + getUser(): User
            + setUser(user: User): void
        }

'        Chef *.. User
'        Booking *.. User
'        Booking *.. Chef
'        RefreshTokens *.. User
    }

    package repository {
        interface ChefRepository {
            + findByChefId(chefId: UUID): Optional<Chef>
            + findChefsFyUser_UserId(userUserId: UUID): Optional<List<Chef>>
        }

        interface UserRepository {
            + findByUsername(username: String): Optional<User>
            + existsByUsername(username: String): boolean
            + findByUserId(userId: UUID): Optional<User>
        }

        interface BookingRepository {
            + findByUser_UserId(userId: UUID): Optional<List<Booking>>
            + findByChef_ChefId(chefId: UUID): Optional<List<Booking>>
            + findByBookingId(bookingId: UUID): Optional<Booking>
            + deleteByBookingId(bookingId: UUID): void
        }

        interface RefreshTokensRepository {
            + deleteByExpiresBefore(time: LocalDateTime): void
            + deleteRefreshTokensByRefreshId(refreshTokenId: UUID): void
            + deleteRefreshTokensByUser_UserId(user_UserId: UUID): void
            + findRefreshTokensByRefreshId(refreshId: UUID): Optional<RefreshTokens>
        }
    }

    package controller {
        class ChefController {
            - chefService: ChefService [1]

            + addChef(authContext: AuthContext, chefCreateDto: ChefCreateDto): ResponseEntity<Chef>
            + getAllChefs(): ResponseEntity<List<Chef>>
            + getChefProfile(id: UUID): ResponseEntity<Chef>
        }

        note right of ChefController::addChef
          Annotated with:
          @RequireAuth
          @PostMapping("/create")
        end note

        note right of ChefController::getAllChefs
          Annotated with:
          @GetMapping("/list")
        end note

        note right of ChefController::getChefProfile
          Annotated with:
          @GetMapping("/profile/{id}")
        end note

        note left of ChefController
          Annotated with:
          @RequestMapping("/chef")
        end note

        class UserController {
            - userService: UserService [1]

            + addUser(userCreateDto: UserCreateDto): ResponseEntity<UserReturnDto>
            + getAllUsers(): ResponseEntity<List<UserReturnDto>>
            + getUser(): ResponseEntity<UserReturnDto>
        }

        note right of UserController::addUser
          Annotated with:
          @PostMapping("/create")
        end note

        note right of UserController::getAllUsers
          Annotated with:
          @GetMapping("/list")
        end note

        note right of UserController::getUser
          Annotated with:
          @RequireAuth
          @GetMapping("/view")
        end note

        note left of UserController
          Annotated with:
          @RequestMapping("/user")
        end note

        class BookingController {
            - bookingService: BookingService [1]

            + bookingRequest(authContext: AuthContext, bookingRequestDto: BookingRequestDto): ResponseEntity<Booking>
            + viewBookingsUser(authContext: AuthContext): ResponseEntity<List<Booking>>
            + viewBookingsChef(authContext: AuthContext, chefId: UUID): ResponseEntity<List<Booking>>
            + viewBooking(authContext: AuthContext, bookingId: UUID): ResponseEntity<Booking>
            + changeStatus(authContext: AuthContext, changeStatusDto: ChangeStatusDto): ResponseEntity<Void>
            + deleteBooking(authContext: AuthContext, bookingId: UUID): ResponseEntity<Void>
        }

        note right of BookingController::bookingRequest
          Annotated with:
          @RequireAuth
          @PostMapping("/create")
        end note

        note right of BookingController::viewBookingsUser
          Annotated with:
          @RequireAuth
          @GetMapping("/list/user")
        end note

        note right of BookingController::viewBookingsChef
          Annotated with:
          @RequireAuth
          @GetMapping("/list/chef/{chefId}")
        end note

        note right of BookingController::viewBooking
          Annotated with:
          @RequireAuth
          @GetMapping("/view/{bookingId}")
        end note

        note right of BookingController::changeStatus
          Annotated with:
          @RequireAuth
          @PutMapping("/update-status")
        end note

        note right of BookingController::deleteBooking
          Annotated with:
          @RequireAuth
          @DeleteMapping("/delete/{bookingId}")
        end note

        note left of BookingController
          Annotated with:
          @RequestMapping("/booking")
        end note

        class AuthController {
            - authService: AuthService [1]

            + login(loginDto: LoginDto, response: HttpServletResponse): ResponseEntity<Map<String, String>>
            + logout(refreshToken: String, response: HttpServletResponse): ResponseEntity<Void>
            + logoutAll(authContext AuthContext, refreshToken: String, response: HttpServletResponse): ResponseEntity<Void>
            + refresh(refreshToken: String, response: HttpServletResponse): ResponseEntity<Map<String, String>>
        }

        note right of AuthController::login
          Annotated with:
          @PostMapping("/login")
        end note

        note right of AuthController::logout
          Annotated with:
          @PostMapping("/logout")
        end note

        note right of AuthController::logoutAll
          Annotated with:
          @RequireAuth
          @PostMapping("/logout/all")
        end note

        note right of AuthController::refresh
          Annotated with:
          @PostMapping("/refresh")
        end note

        note left of AuthController
          Annotated with:
          @RequestMapping("/auth")
        end note

        class GlobalExceptionHandler {
            + handleUsernameTakenException(ex: UsernameTakenException): ProblemDetail
            + handleInvalidUserException(ex: InvalidUserException): ProblemDetail
            + handleInvalidBookingException(ex: InvalidBookingException): ProblemDetail
            + handleMethodArgumentNotValidException(ex: MethodArgumentNotValidException): ResponseEntity<Map<String, Object>>
            + handleUnauthorizedUserException(ex: UnauthorizedUser): ProblemDetail
        }

        class WebConfig {
            - authRequiredInterceptor: AuthRequiredInterceptor [1]

            + addInterceptors(registry: InterceptorRegistry): void
        }

        class WebCorsConfig {
            + addCorsMappings(registry: CorsRegistry): void
        }
    }

    package dto {
        class ChefCreateDto {
            - price: double [1]
            - listingName: String [1]

            + getPrice(): double
            + getListingName(): String
        }

        class UserCreateDto {
            - username: String [1]
            - name: String [1]
            - password: String [1]

            + getUsername(): String
            + getName(): String
            + getPassword(): String
        }

        class BookingRequestDto {
            - chefId: UUID [1]
            - start: LocalDateTime [1]
            - end: LocalDateTime [1]
            - address: String [1]

            + getChefId(): UUID
            + getStart(): LocalDateTime
            + getEnd(): LocalDateTime
            + getAddress(): String
        }

        class ChangeStatusDto {
            - bookingId: UUID [1]
            - status: String [1]

            + getBookingId(): UUID
            + getStatus(): String
        }

        class LoginDto {
            - username: String [1]
            - password: String [1]

            + getUsername(): String
            + getPassword(): String
        }

        class UserReturnDto {
            - userId: UUID [1]
            - username: String [1]
            - name: String [1]

            + getUserId(): UUID
            + getUsername(): String
            + getName(): String
        }
    }

    package service {
        package exceptions {
            class InvalidBookingException {}
            class InvalidUserException {}
            class UnauthorizedUser {}
            class UsernameTakenException {}
        }

        class ChefService {
            - chefRepository: ChefRepository [1]
            - userRepository: UserRepository [1]

            + createChef(chefCreateDto: ChefCreateDto, authContext: AuthContext): Chef
            + getAllChefs(): List<Chef>
            + getChefProfile(id: UUID): Chef
        }

        class UserService {
            - userRepository: UserRepository [1]

            + createUser(userCreateDto: UserCreateDto): User
            + getAllUsers(): List<User>
            + getUser(userId: UUID): User
        }

        class BookingService {
            - bookingRepository: BookingRepository [1]
            - userRepository: UserRepository [1]
            - chefRepository: ChefRepository [1]

            + bookingRequest(bookingRequestDto: BookingRequestDto, authContext: AuthContext): Booking
            + viewBookingsUser(userId: UUID): List<Booking>
            + viewBookingsChef(chefId: UUID, authContext: AuthContext): List<Booking>
            + viewBooking(bookingId: UUID, authContext: AuthContext): Booking
            + changeStatus(changeStatusDto: ChangeStatusDto, authContext: AuthContext): void
            + deleteBooking(bookingId: UUID, authContext: AuthContext): void
        }

        class AuthService {
            - userRepository: UserRepository [1]
            - jwtService: JwtService [1]
            - refreshTokensRepository: RefreshTokensRepository [1]

            + login(loginDto: LoginDto): Map<String, String>
            + logout(refreshToken: String): void
            + logoutAll(authContext: AuthContext): void
            + refresh(refreshToken: String): Map<String, String>
        }

        class JwtService {
            - accessSecret: Key [1]
            - refreshSecret: Key [1]

            + generateAccessToken(userId: UUID, username: String, name: String): String
            + generateRefreshToken(userId: UUID): String
            + isValidAccessToken(token: String): boolean
            + isValidRefreshToken(token: String): boolean
            - validateToken(token: String, key: Key): boolean
            + getUserId(token: String): UUID
            + getUsername(token: String): String
            + getName(token: String): String
            + getRefreshUserId(token: String): UUID
            + getRefreshJit(token: String): String
            - getClaimsFromToken(token: String, key: Key): Claims
        }
    }

    package dataobjects {
        class ApplicationJwtBuilder {
            - secret: Key [1]
            - expire: int [1]
            - userId: UUID [1]
            - username: String [1]
            - name: String [1]
            - type: String [1]

            + setType(type: String): ApplicationJwtBuilder
            + setUserId(userId: UUID): ApplicationJwtBuilder
            + setUsername(username: String): ApplicationJwtBuilder
            + setName(name: String): ApplicationJwtBuilder
            + setSecret(secret: Key): ApplicationJwtBuilder
            + setExpire(expire: int): ApplicationJwtBuilder
            + build(): String
        }

        class AuthContext {
            - userId: UUID [1]
            - username: String [1]
            - name: String [1]

            + getUserId(): UUID
            + getUsername(): String
            + getName(): String
        }
    }

    package annotations {
        interface RequireAuth {}
    }

    package components {
        class AuthFilter {
            - jwtService: JwtService [1]

            # doFilterInternal(request: HttpServletRequest, response: HttpServletResponse, filterChain: FilterChain): void
        }

        class AuthRequiredInterceptor {
            + preHandle(request: HttpServletRequest, response: HttpServletResponse, handler: Object): boolean
        }
    }

    class Application {
        main(args: String[*]): void
    }

    Chef *-- User
    Booking *-- User
    Booking *-- Chef
    RefreshTokens *-- User

    WebConfig *-- AuthRequiredInterceptor


    AuthFilter o-- JwtService
    AuthController o-- AuthService
    BookingController o-- BookingService
    UserController o-- UserService
    ChefController o-- ChefService
    AuthService o-- JwtService

    ChefService o-- ChefRepository
    ChefService o-- UserRepository
    UserService o-- UserRepository
    BookingService o-- ChefRepository
    BookingService o-- UserRepository
    BookingService o-- BookingRepository
    AuthService o-- UserRepository
    AuthService o-- RefreshTokensRepository


    OncePerRequestFilter <|-- AuthFilter
    HandlerInterceptor <|-- AuthRequiredInterceptor
    WebMvcConfigurer <|-- WebConfig
    WebMvcConfigurer <|-- WebCorsConfig

    JpaRepository <|-- BookingRepository
    JpaRepository <|-- ChefRepository
    JpaRepository <|-- RefreshTokensRepository
    JpaRepository <|-- UserRepository


    SpringApplication <.. Application


    RequireAuth <.. AuthRequiredInterceptor
    RequireAuth <.. AuthController
    RequireAuth <.. BookingController
    RequireAuth <.. ChefController
    RequireAuth <.. UserController


    LoginDto <.. AuthController

    BookingRequestDto <.. BookingController
    BookingRequestDto <.. BookingService

    ChangeStatusDto <.. BookingController
    ChangeStatusDto <.. BookingService

    ChefCreateDto <.. ChefController
    ChefCreateDto <.. ChefService

    UserCreateDto <.. UserRepository
    UserCreateDto <.. UserService
    UserReturnDto <.. UserRepository


    AuthContext <.. AuthFilter
    AuthContext <.. AuthRequiredInterceptor

    AuthContext <.. AuthController
    AuthContext <.. BookingController
    AuthContext <.. ChefController
    AuthContext <.. UserController

    AuthContext <.. AuthService
    AuthContext <.. BookingService
    AuthContext <.. ChefService

    ApplicationJwtBuilder <.. ApplicationJwtBuilder
    ApplicationJwtBuilder <.. JwtService


    AuthRequiredInterceptor <.. WebConfig


    Booking <.. BookingService
    Booking <.. BookingController
    Booking <.. BookingRepository

    Chef <.. Booking
    Chef <.. ChefController
    Chef <.. BookingService
    Chef <.. ChefService
    Chef <.. ChefRepository

    RefreshTokens <.. JwtService
    RefreshTokens <.. RefreshTokensRepository

    User <.. Booking
    User <.. Chef
    User <.. RefreshTokens
    User <.. BookingService
    User <.. UserService
    User <.. UserController
    User <.. UserRepository
    User <.. AuthService


    BookingRepository <.. BookingService

    ChefRepository <.. BookingService
    ChefRepository <.. ChefService

    RefreshTokensRepository <.. AuthService
    RefreshTokensRepository <.. JwtService

    UserRepository <.. AuthService
    UserRepository <.. BookingService
    UserRepository <.. ChefService
    UserRepository <.. JwtService
    UserRepository <.. UserService


    InvalidBookingException <.. GlobalExceptionHandler
    InvalidBookingException <.. BookingService

    InvalidUserException <.. GlobalExceptionHandler
    InvalidUserException <.. AuthService
    InvalidUserException <.. ChefService
    InvalidUserException <.. JwtService
    InvalidUserException <.. UserService

    UnauthorizedUser <.. GlobalExceptionHandler
    UnauthorizedUser <.. AuthService
    UnauthorizedUser <.. BookingService

    UsernameTakenException <.. GlobalExceptionHandler
    UsernameTakenException <.. UserService


    AuthService <.. AuthController
    BookingService <.. BookingController
    ChefService <.. ChefController
    JwtService <.. AuthService
    JwtService <.. AuthFilter
    UserService <.. UserController


'    User <.. UserController
'    User <.. BookingService
'    User <.. UserService
'    User <.. UserRepository
'    User <.. AuthService



'    ChefCreateDto <.. ChefController
'    ChefCreateDto <.. ChefService
'    UserCreateDto <.. UserController
'    UserCreateDto <.. UserService
'    BookingRequestDto <.. BookingController
'    BookingRequestDto <.. BookingService
'    ChangeStatusDto <.. BookingController
'    ChangeStatusDto <.. BookingService
'    LoginDto <.. AuthController
'    LoginDto <.. AuthService
'    UserReturnDto <.. UserController
'
'    ChefService *-- ChefRepository
'    ChefService *-- UserRepository
'    UserService *-- UserRepository
'    BookingService *-- BookingRepository
'    BookingService *-- ChefRepository
'    BookingService *-- UserRepository
'    AuthService *-- UserRepository
'    JwtService *-- AuthFilter
'
'    InvalidUserException <.. ChefService
'    UsernameTakenException <.. UserService
'    InvalidUserException <.. GlobalExceptionHandler
'    UsernameTakenException <.. GlobalExceptionHandler
'
'    Application ..> SpringApplication
'    SpringApplication ..> BookingController
'    SpringApplication ..> GlobalExceptionHandler
'    SpringApplication ..> UserController
'    SpringApplication ..> ChefController
'    SpringApplication ..> AuthController
'
'    ApplicationJwtBuilder <.. JwtService
'    AuthContext <.. AuthService
'    AuthContext <.. AuthController
'
'    OncePerRequestFilter <|-- AuthFilter
'
'    HandlerInterceptor <.. AuthRequiredInterceptor



    'Figure out requireauth connection




}

@enduml